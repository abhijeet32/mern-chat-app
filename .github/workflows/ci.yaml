name: chat-app
on: push

env:
    DATABASE_URI: ${{secrets.DATABASE_URI}}
    JWT_SECRET: ${{secrets.JWT_SECRET}}

jobs:
    Unit-Testing:

        runs-on: ubuntu-latest
        steps:
        - name: Checkout code
          uses: actions/checkout@v3

        - name: Set up Node.js
          uses: actions/setup-node@v3
          with:
            node-version: '18'
            cache: 'npm'

        - name: Install dependecies
          run: npm ci

        - name: Build the app
          run:  npm run build

    Docker:
        runs-on: ubuntu-latest
        needs: Unit-Testing

        steps:
        - name: Pull Docker Image
          run: |
            docker pull abhi0874/chatapp-multistage:v1
            docker images
        
        - name: Run Docker Container
          run: docker run -d -p 8000:8000 abhi0874/chatapp-multistage:v1

        - name: Check if app is running
          run: |
            sleep 10
            curl http://localhost:8000